@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Chi ti·∫øt tour";
    var tour = ViewData["tour"] as TourBookingSystem.Models.Tour;
    var relatedTours = ViewData["relatedTours"] as List<TourBookingSystem.Models.Tour>;
}

@if (tour != null)
{
    <div class="tour-detail-page">
        <div class="tour-detail-header">
            <h1>@tour.getName()</h1>
            <p class="destination">üìç @tour.getDestination()</p>
        </div>
        
        <div class="tour-detail-content">
            <div class="tour-main-info">
                <img src="@tour.getImageUrl()" alt="@tour.getName()" class="tour-main-image">
                
                <div class="tour-description">
                    <h2>M√¥ t·∫£ tour</h2>
                    <p>@tour.getDescription()</p>
                </div>
                
                <div class="tour-info-grid">
                    <div class="info-item">
                        <span class="label">Th·ªùi gian:</span>
                        <span class="value">@tour.getDuration() ng√†y</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Kh·ªüi h√†nh:</span>
                        <span class="value">@tour.getFormattedDepartureDate()</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Gi√°:</span>
                        <span class="value price">@tour.getFormattedPrice()</span>
                    </div>
                    <div class="info-item">
                        <span class="label">S·ªë ch·ªó c√≤n:</span>
                        <span class="value">@tour.getAvailableSlots()</span>
                    </div>
                </div>
            </div>
            
            <div class="tour-sidebar">
                <div class="booking-box">
                    <h3>ƒê·∫∑t tour</h3>
                    <p class="booking-price">@tour.getFormattedPrice() / ng∆∞·ªùi</p>
                    
                    @if (ViewData["userId"] != null)
                    {
                        <form id="bookingForm">
                            <input type="hidden" name="tourId" value="@tour.getTourId()">
                            <div class="form-group">
                                <label>S·ªë l∆∞·ª£ng ng∆∞·ªùi</label>
                                <input type="number" id="quantity" name="quantity" value="1" min="1" max="@tour.getAvailableSlots()">
                            </div>
                            <div class="form-group">
                                <label>Ghi ch√∫</label>
                                <textarea name="notes" rows="3" placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát..."></textarea>
                            </div>
                            <button type="button" class="btn btn-primary btn-block" onclick="submitBooking()">ƒê·∫∑t tour</button>
                        </form>
                    }
                    else
                    {
                        <p>Vui l√≤ng <a href="@Url.Action("Login", "Account")">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ ƒë·∫∑t tour</p>
                    }
                </div>
            </div>
        </div>
        
        @if (relatedTours != null && relatedTours.Count > 0)
        {
            <div class="related-tours">
                <h2>Tour li√™n quan</h2>
                <div class="tour-grid">
                    @foreach (var relatedTour in relatedTours)
                    {
                        <div class="tour-card">
                            <img src="@relatedTour.getImageUrl()" alt="@relatedTour.getName()">
                            <div class="tour-info">
                                <h3>@relatedTour.getName()</h3>
                                <p class="destination">@relatedTour.getDestination()</p>
                                <p class="price">@relatedTour.getFormattedPrice()</p>
                                <a href="@Url.Action("TourDetail", "Home", new { id = relatedTour.getTourId() })" class="btn btn-secondary">Chi ti·∫øt</a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="not-found">
        <h1>Tour kh√¥ng t·ªìn t·∫°i</h1>
        <a href="@Url.Action("TourList", "Home")" class="btn btn-primary">Quay l·∫°i danh s√°ch</a>
    </div>
}

@section Scripts {
    <script>
        function submitBooking() {
            var tourId = @tour.getTourId();
            var quantity = document.getElementById('quantity').value;
            var notes = document.querySelector('textarea[name="notes"]').value;
            
            fetch('@Url.Action("Index", "Booking")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=create&tourId=' + tourId + '&quantity=' + quantity + '&notes=' + encodeURIComponent(notes)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    window.location.href = '@Url.Action("Index", "Booking")';
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra!');
            });
        }
    </script>
}
